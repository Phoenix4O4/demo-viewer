define(["exports"],(function(e){"use strict";function l(e,l){let t=e[0],a=e[3],r=e[1],n=e[4],i=e[2],o=e[5],p=l[0],s=l[3],u=l[1],_=l[4],d=l[2],c=l[5];return e[0]=t*p+s*r,e[3]=p*a+s*n,e[1]=t*u+r*_,e[4]=a*u+n*_,e[2]=i+t*d+r*c,e[5]=a*d+o+n*c,e}function t(e,l){let t=l[0],a=l[3],r=l[1],n=l[4],i=l[2],o=l[5],p=e[0],s=e[3],u=e[1],_=e[4],d=e[2],c=e[5];return e[0]=t*p+s*r,e[3]=p*a+s*n,e[1]=t*u+r*_,e[4]=a*u+n*_,e[2]=i+t*d+r*c,e[5]=a*d+o+n*c,e}function a(e){let l=e[0],t=e[3],a=e[1],r=e[4],n=e[2],i=e[5],o=l*r-t*a;if(0!=o)return e[0]=r/o,e[3]=t/-o,e[1]=a/-o,e[4]=l/o,e[2]=(r*n-a*i)/-o,e[5]=(t*n-l*i)/o,e}function r(e=0,l=1,t=0){return l*t+e*(1-t)}function n(e,l){let a=e[0]*e[0]+e[3]*e[3],r=e[1]*e[1]+e[4]*e[4];if(r<1e-6||a<1e-6)return;let n=Math.sqrt(a),i=Math.sqrt(r),o=-1,p=0;if(e[0]/n>o&&(p=-e[3],o=e[0]/n),e[4]/i>o&&(p=e[1],o=e[4]/i),o>=.9999)return l[0]=e[0],l[1]=e[1],l[2]=e[2],l[3]=e[3],l[4]=e[4],l[5]=e[5],0;if(o<=-.9999)return l[0]=-e[0],l[1]=-e[1],l[2]=-e[2],l[3]=-e[3],l[4]=e[4],l[5]=e[5],Math.PI;Math.abs(o)<1e-4&&(o=0);let s=Math.acos(o),u=Math.sqrt(1-o*o);return p<0&&(s=-s,u=-u),l[0]=e[0],l[1]=e[1],l[3]=e[3],l[4]=e[4],t(l,[o,-u,0,u,o,0]),l[2]=e[2],l[5]=e[5],s}var i;e.FilterType=void 0,(i=e.FilterType||(e.FilterType={}))[i.Blur=1]="Blur",i[i.Outline=2]="Outline",i[i.DropShadow=3]="DropShadow",i[i.MotionBlur=4]="MotionBlur",i[i.Wave=5]="Wave",i[i.Ripple=6]="Ripple",i[i.Alpha=7]="Alpha",i[i.Displace=8]="Displace",i[i.Color=9]="Color",i[i.RadialBlur=10]="RadialBlur",i[i.AngularBlur=11]="AngularBlur",i[i.Rays=12]="Rays",i[i.Layer=13]="Layer",i[i.Bloom=14]="Bloom",e.Appearance=void 0,function(e){const t=[];function r(e,l=0){return(l<-1e4||l>1e4)&&(l=r(l)),(e<-1e4||e>1e4)&&(e=l+e+32767<<16>>16),13!=e&&-197!=e&&-407!=e&&-617!=e||(e=-32767),e}function n(e){if(e.sorted_appearances)return e.sorted_appearances;let l=[],a=[];for(let t of e.underlays)t=i(e,t),r(t.plane,e.plane)!=r(e.plane)?a.push(t):l.push(...n(t));l.push(e);for(let t of[...e.overlays].sort(((l,t)=>{let a=l.layer<0?e.layer:l.layer,r=t.layer<0?e.layer:t.layer;if(a<r)return a-r;let n=l.layer<0?l.layer:-1,i=t.layer<0?t.layer:-1;return n<i?n-i:0})))t=i(e,t),r(t.plane,e.plane)!=r(e.plane)?a.push(t):l.push(...n(t));return e.sorted_appearances=l,e.floating_appearances=a.length?a:t,l}function i(e,t){let a=!1,n=()=>{a||(a=!0,t=Object.assign({},t))};var i;if(12==t.plane&&(t.plane=10,t.layer=.02,t.blend_mode=4),11==t.plane&&(t.plane=10),t.dir==e.dir||t.dir_override||(n(),t.dir=e.dir),(e.pixel_x||e.pixel_y||e.pixel_z||e.pixel_w&&!(8&t.appearance_flags))&&(n(),t.pixel_x+=e.pixel_x,t.pixel_y+=e.pixel_y,t.pixel_z+=e.pixel_z,t.pixel_w+=e.pixel_w),8&t.appearance_flags||1==(i=e.transform)[0]&&0==i[1]&&0==i[2]&&0==i[3]&&1==i[4]&&0==i[5]||(n(),t.transform=[...t.transform],l(t.transform,e.transform)),4278190080!=(4278190080&e.color_alpha)&&!(4&t.appearance_flags)&&10!=e.plane){n();let l=Math.round((e.color_alpha>>>24)*(t.color_alpha>>>24)/255);t.color_alpha=16777215&t.color_alpha|l<<24}if(16777215!=(16777215&e.color_alpha)&&!(2&t.appearance_flags)){n();let l=4278190080&t.color_alpha;for(let a=0;a<24;a+=8){l|=Math.round((e.color_alpha>>>a&255)*(t.color_alpha>>>a&255)/255)<<a}t.color_alpha=l}return 0==t.blend_mode&&e.blend_mode>0&&(n(),t.blend_mode=e.blend_mode),(t.plane<-1e4||t.plane>1e4)&&(n(),t.plane=r(t.plane,e.plane)),t}e.resolve_plane=r,e.is_lighting_plane=function(e){return e>=12&&e<=12},e.get_appearance_parts=n,e.overlay_inherit=i,e.get_display_boundary=function(e){var l,t,a,r,i,o;let p=1/0,s=-1/0,u=1/0,_=-1/0;for(let d of n(e)){let e=null!==(a=null===(t=null===(l=d.icon_state_dir)||void 0===l?void 0:l.atlas_node)||void 0===t?void 0:t.width)&&void 0!==a?a:32,n=null!==(o=null===(i=null===(r=d.icon_state_dir)||void 0===r?void 0:r.atlas_node)||void 0===i?void 0:i.height)&&void 0!==o?o:32;for(let l of[-.5,.5])for(let t of[-.5,.5]){let a=d.transform[0]*l*e+d.transform[1]*t*n+d.transform[2]+.5*e+d.pixel_x+d.pixel_w,r=d.transform[3]*l*e+d.transform[4]*t*n+d.transform[5]+.5*n+d.pixel_y+d.pixel_z;p=Math.min(p,a),s=Math.max(s,a),u=Math.min(u,r),_=Math.max(_,r)}}return p>s||u>_?{x:0,y:0,width:0,height:0}:{x:p,y:u,width:s-p,height:_-u}},e.check_appearance_click=function(e,l,t,r=!1){var i;let o=n(e);for(let n=o.length-1;n>=0;n--){let p=r?2:e.mouse_opacity;if(0==p)continue;let s=o[n],u=a([...s.transform]);if(!u)continue;let _=null===(i=s.icon_state_dir)||void 0===i?void 0:i.current_frame;if(!_&&p<=1)continue;let d=32,c=32;_&&(d=_.sprite_data.width,c=_.sprite_data.height);let f=l-d/2-s.pixel_x-s.pixel_w,h=t-c/2-s.pixel_y-s.pixel_z,x=f*u[0]+h*u[1]+u[2]+d/2,m=f*u[3]+h*u[4]+u[5]+c/2;if(!(x<0||m<0||x>=d||m>=c)&&!(p<=1&&_&&0==_.sprite_data.data[4*(Math.floor(c-m)*d+Math.floor(x))+3]))return!0}return!1},e.parse_screen_loc=function e(l,t=15,a=15,r=32,n=r){if(l.includes(" to ")){let[i,o]=l.split(" to ");null!=o||(o=i);let[p,s]=e(i,t,a,r,n)[0],[u,_]=e(o,t,a,r,n)[0],d=[];for(let e=s;e<=_;e++)for(let l=p;l<=u;l++)d.push([l,e]);return d}let[i,o]=l.split(",");null!=o||(o=i),(i.includes("NORTH")||i.includes("SOUTH")||i.includes("TOP")||i.includes("BOTTOM")||o.includes("EAST")||o.includes("WEST")||o.includes("LEFT")||o.includes("RIGHT"))&&([i,o]=[o,i]);let p=0,s=0;for(let e=0;e<2;e++){let l=e?o:i,u=0,_=0,d=0,c=0;for(;l[u]>="A"&&l[u]<="Z";)u++;let f=l.substring(0,u);l=l.substring(u),"CENTER"==f?_=.5:e&&f.startsWith("NORTH")?_=1:e&&f.startsWith("SOUTH")?_=0:!e&&f.endsWith("EAST")?_=1:!e&&f.endsWith("WEST")?_=0:e&&f.startsWith("TOP")?_=1:e&&f.startsWith("BOTTOM")?_=0:!e&&f.endsWith("RIGHT")?_=1:!e&&f.endsWith("LEFT")?_=0:d--;let[h,x]=l.split(":");h.startsWith("+")&&(h=h.substring(1)),h.endsWith("%")?_+=+h.substring(0,h.length-1)/100:d+=+h,x&&(c+=+x);let m=_*((e?a:t)-1)+d+c/(e?n:r);e?s=m:p=m}return[[p,s]]}}(e.Appearance||(e.Appearance={})),e.ReaderAppearance=void 0,(e.ReaderAppearance||(e.ReaderAppearance={})).base={icon:null,icon_state:null,name:null,appearance_flags:0,layer:2,plane:-32767,dir:2,color_alpha:-1,pixel_x:0,pixel_y:0,pixel_z:0,pixel_w:0,blend_mode:0,glide_size:8,screen_loc:null,transform:[1,0,0,0,1,0],invisibility:0,overlays:[],underlays:[],opacity:!1,density:!1,dir_override:!0,override:!1,color_matrix:null,maptext:null,mouse_opacity:1,animate_movement:1,filters:[],vis_flags:0},e.LONG_GLIDE=1,e.MAX_LAYER=32,e.SEE_MOBS=4,e.SEE_OBJS=8,e.SEE_THRU=512,e.SEE_TURFS=16,e.SOUND_MUTE=1,e.SOUND_PAUSED=2,e.SOUND_STREAM=4,e.SOUND_UPDATE=16,e.matrix_equals=function(e,l){return e[0]==l[0]&&e[1]==l[1]&&e[2]==l[2]&&e[3]==l[3]&&e[4]==l[4]&&e[5]==l[5]},e.matrix_interpolate=function e(l,a,i,o=!1){if(o)return[r(l[0],a[0],i),r(l[1],a[1],i),r(l[2],a[2],i),r(l[3],a[3],i),r(l[4],a[4],i),r(l[5],a[5],i)];let p=[0,0,0,0,0,0],s=[0,0,0,0,0,0],u=n(l,p),_=n(a,s);if(null==u||null==_)return e(l,a,i,!0);let d=_-u;if(d=((d+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI)-Math.PI,Math.abs(d)>=1e-4&&Math.abs(d)<Math.PI-1e-4){let e=u+i*d,l=[r(p[0],s[0],i),r(p[1],s[1],i),0,r(p[3],s[3],i),r(p[4],s[4],i),0],a=Math.cos(e),n=Math.sin(e);return t(l,[a,n,0,-n,a,0]),l[2]=r(p[2],s[2],i),l[5]=r(p[5],s[5],i),l}return e(l,a,i,!0)},e.matrix_invert=a,e.matrix_multiply=l,e.matrix_premultiply=t,e.matrix_translate=function(e,l=0,t=0){return e[2]+=l,e[5]+=t,e}}));
